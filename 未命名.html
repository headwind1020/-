<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ›ä¸šè®¡åˆ’ä¹¦åä½œè®¨è®ºå¹³å°</title>
  <!-- å¼•å…¥Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¼•å…¥Font Awesomeå›¾æ ‡ -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰²å’Œå­—ä½“ -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#07C160', // å¾®ä¿¡ç»¿ä¸»è‰²è°ƒ
            secondary: '#F5F5F5',
            neutral: '#888888',
            dark: '#333333',
            light: '#FAFAFA'
          },
          fontFamily: {
            sans: ['PingFang SC', 'Microsoft YaHei', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .chat-bubble-left {
        @apply bg-white rounded-lg rounded-l-none shadow-sm p-3 max-w-[70%];
      }
      .chat-bubble-right {
        @apply bg-primary text-white rounded-lg rounded-r-none shadow-sm p-3 max-w-[70%];
      }
      .card-hover {
        @apply hover:shadow-md transition-shadow duration-300 hover:-translate-y-1;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
    }
  </style>
</head>
<body class="bg-light font-sans text-dark min-h-screen flex flex-col">
  <!-- å¯¼èˆªæ ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
  <nav id="navbar" class="hidden fixed top-0 left-0 right-0 bg-white shadow-sm z-50 py-3 px-4 md:px-6">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2">
        <i class="fa fa-lightbulb-o text-primary text-xl"></i>
        <h1 class="text-lg md:text-xl font-bold">åˆ›ä¸šè®¡åˆ’ä¹¦åä½œå¹³å°</h1>
      </div>
      <div class="flex items-center gap-4 md:gap-6">
        <button id="tab-discuss" class="text-sm md:text-base font-medium text-primary border-b-2 border-primary pb-1">è®¨è®ºåŒº</button>
        <button id="tab-business-plan" class="text-sm md:text-base font-medium text-neutral hover:text-primary pb-1 transition-colors">åˆ›ä¸šè®¡åˆ’ä¹¦</button>
        <button id="tab-knowledge" class="text-sm md:text-base font-medium text-neutral hover:text-primary pb-1 transition-colors">çŸ¥è¯†åº“</button>
        <div class="flex items-center gap-2">
          <span id="user-name" class="text-sm md:text-base"></span>
          <button id="logout-btn" class="text-sm text-neutral hover:text-red-500 transition-colors">
            <i class="fa fa-sign-out"></i> é€€å‡º
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- ç™»å½•/æ³¨å†Œé¡µé¢ -->
  <section id="login-page" class="flex-1 flex flex-col items-center justify-center p-4 bg-secondary">
    <div class="bg-white rounded-xl shadow-md p-6 md:p-8 w-full max-w-md">
      <div class="text-center mb-6">
        <i class="fa fa-lightbulb-o text-primary text-3xl mb-2"></i>
        <h2 class="text-xl md:text-2xl font-bold">åˆ›ä¸šè®¡åˆ’ä¹¦åä½œå¹³å°</h2>
        <p class="text-neutral text-sm mt-2">ä»…é™7åç”¨æˆ·å‚ä¸åä½œ</p>
      </div>
      
      <!-- ç™»å½•/æ³¨å†Œåˆ‡æ¢ -->
      <div class="flex border-b border-gray-200 mb-6">
        <button id="login-tab" class="flex-1 py-2 text-sm font-medium text-primary border-b-2 border-primary">ç™»å½•</button>
        <button id="register-tab" class="flex-1 py-2 text-sm font-medium text-neutral hover:text-primary">æ³¨å†Œ</button>
      </div>
      
      <!-- ç™»å½•è¡¨å• -->
      <form id="login-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-dark mb-1">ç”¨æˆ·å</label>
          <input type="text" id="login-username" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-dark mb-1">å¯†ç </label>
          <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary" placeholder="è¯·è¾“å…¥å¯†ç " required>
        </div>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center gap-2">
          <i class="fa fa-sign-in"></i> ç™»å½•
        </button>
      </form>
      
      <!-- æ³¨å†Œè¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
      <form id="register-form" class="space-y-4 hidden">
        <div>
          <label class="block text-sm font-medium text-dark mb-1">ç”¨æˆ·å</label>
          <input type="text" id="reg-username" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-dark mb-1">å¯†ç </label>
          <input type="password" id="reg-password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary" placeholder="è¯·è¾“å…¥å¯†ç " required>
        </div>
        <div class="text-sm text-neutral mb-0">
          å‰©ä½™å¯æ³¨å†Œåé¢ï¼š<span id="register-quota" class="font-medium text-primary">7</span>/7
        </div>
        <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center gap-2">
          <i class="fa fa-user-plus"></i> æ³¨å†Œ
        </button>
      </form>
    </div>
  </section>

  <!-- ä¸»å†…å®¹åŒºï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
  <main id="main-content" class="hidden flex-1 pt-16 p-4 md:p-6 flex flex-col gap-4 max-w-7xl mx-auto w-full">
    <!-- è®¨è®ºåŒº Tab -->
    <section id="discuss-tab" class="flex-1 flex flex-col gap-4">
      <!-- å‘èµ·æ–°è®®é¢˜ -->
      <div class="bg-white rounded-lg shadow-sm p-4 md:p-5">
        <h3 class="font-medium text-lg mb-3 flex items-center gap-2">
          <i class="fa fa-plus-circle text-primary"></i> å‘èµ·æ–°åˆ›ä¸šè®®é¢˜
        </h3>
        <form id="new-topic-form" class="flex flex-col md:flex-row gap-3">
          <input type="text" id="topic-title" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary" placeholder="è¯·è¾“å…¥åˆ›ä¸šè®®é¢˜æ ‡é¢˜ï¼ˆå¦‚ï¼šæ–°é›¶å”®åˆ›ä¸šé¡¹ç›®å¯è¡Œæ€§åˆ†æï¼‰" required>
          <textarea id="topic-content" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary h-16 md:h-auto" placeholder="è¯·è¯¦ç»†æè¿°è®®é¢˜é—®é¢˜/èƒŒæ™¯..." required></textarea>
          <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors whitespace-nowrap">
            å‘èµ·è®®é¢˜
          </button>
        </form>
      </div>

      <!-- è®®é¢˜åˆ—è¡¨ + å¯¹è¯åŒº -->
      <div class="flex-1 flex flex-col md:flex-row gap-4 h-[calc(100vh-200px)]">
        <!-- è®®é¢˜åˆ—è¡¨ï¼ˆå«å­˜æ¡£ï¼‰ -->
        <div class="w-full md:w-80 bg-white rounded-lg shadow-sm overflow-hidden flex flex-col">
          <div class="flex justify-between items-center p-3 border-b border-gray-200">
            <h3 class="font-medium">è®®é¢˜åˆ—è¡¨</h3>
            <div class="flex gap-2">
              <button id="active-topics" class="text-sm text-primary border-b border-primary pb-1">è¿›è¡Œä¸­</button>
              <button id="archive-topics" class="text-sm text-neutral hover:text-primary pb-1">å·²å­˜æ¡£</button>
            </div>
          </div>
          <div id="topics-list" class="flex-1 overflow-y-auto scrollbar-hide p-2">
            <div class="text-center text-neutral py-10">
              æš‚æ— è®®é¢˜ï¼Œå¿«æ¥å‘èµ·ç¬¬ä¸€ä¸ªåˆ›ä¸šè®®é¢˜å§ï¼
            </div>
          </div>
        </div>

        <!-- å¾®ä¿¡å¼å¯¹è¯åŒº -->
        <div id="chat-area" class="flex-1 bg-white rounded-lg shadow-sm overflow-hidden flex flex-col hidden">
          <!-- è®®é¢˜æ ‡é¢˜æ  -->
          <div class="p-3 border-b border-gray-200 flex justify-between items-center">
            <h3 id="chat-topic-title" class="font-medium"></h3>
            <div id="chat-topic-status" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">
              è®¨è®ºä¸­
            </div>
          </div>
          <!-- å¯¹è¯å†…å®¹ -->
          <div id="chat-messages" class="flex-1 p-4 bg-secondary/50 overflow-y-auto scrollbar-hide flex flex-col gap-4">
            <!-- å¯¹è¯å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
          </div>
          <!-- å‘èµ·äººæ“ä½œåŒºï¼ˆä»…å‘èµ·äººå¯è§ï¼‰ -->
          <div id="founder-actions" class="p-3 border-t border-gray-200 hidden">
            <button id="end-discuss-btn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-colors">
              ç»“æŸè®¨è®ºå¹¶æ’°å†™æ€»ç»“
            </button>
          </div>
          <!-- ç•™è¨€è¾“å…¥æ¡† -->
          <div class="p-3 border-t border-gray-200">
            <form id="message-form" class="flex gap-2">
              <textarea id="message-content" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary h-12 resize-none" placeholder="è¯·è¾“å…¥ä½ çš„è®¨è®ºç•™è¨€..." required></textarea>
              <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                å‘é€
              </button>
            </form>
          </div>
          <!-- åˆ›ä¸šè®¡åˆ’ä¹¦å±•ç¤ºåŒºåŸŸ -->
          <div id="business-plan-area" class="border-t border-gray-200 bg-gray-50">
            <div class="p-3 border-b border-gray-200 flex justify-between items-center cursor-pointer" id="business-plan-toggle">
              <div class="flex items-center gap-2">
                <i class="fa fa-file-text-o text-primary"></i>
                <span class="font-medium text-sm">åˆ›ä¸šè®¡åˆ’ä¹¦</span>
                <span id="plan-progress" class="text-xs text-neutral">å®Œæˆåº¦ï¼š0%</span>
              </div>
              <i class="fa fa-chevron-down text-neutral text-sm transition-transform" id="plan-toggle-icon"></i>
            </div>
            <div id="business-plan-content" class="p-4 hidden">
              <div id="plan-outline" class="space-y-3">
                <!-- è®¡åˆ’ä¹¦æçº²åŠ¨æ€ç”Ÿæˆ -->
              </div>
              <div class="mt-4 pt-4 border-t border-gray-200">
                <button id="edit-plan-btn" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors text-sm">
                  <i class="fa fa-edit mr-1"></i> ç¼–è¾‘è®¡åˆ’ä¹¦
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- åˆ›ä¸šè®¡åˆ’ä¹¦ Tabï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <section id="business-plan-tab" class="hidden flex-1 flex flex-col gap-4">
      <!-- è®¡åˆ’ä¹¦æ ‡é¢˜å’Œè¿›åº¦ -->
      <div class="bg-white rounded-lg shadow-sm p-4 md:p-5">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-medium text-lg flex items-center gap-2">
            <i class="fa fa-file-text-o text-primary"></i> åˆ›ä¸šè®¡åˆ’ä¹¦
          </h3>
          <button id="edit-full-plan-btn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors text-sm">
            <i class="fa fa-edit mr-1"></i> ç¼–è¾‘è®¡åˆ’ä¹¦
          </button>
        </div>
        <div class="mb-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium">å®Œæˆåº¦</span>
            <span id="full-plan-progress" class="text-sm text-primary font-medium">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="full-plan-progress-bar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- è®¡åˆ’ä¹¦å†…å®¹ -->
      <div class="flex-1 bg-white rounded-lg shadow-sm p-4 md:p-5 overflow-y-auto">
        <div id="full-plan-content" class="space-y-6">
          <!-- è®¡åˆ’ä¹¦ç« èŠ‚åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </section>

    <!-- çŸ¥è¯†åº“ Tabï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <section id="knowledge-tab" class="hidden flex-1 flex flex-col gap-4">
      <!-- ä¸Šä¼ èµ„æ–™ + æœç´¢ -->
      <div class="bg-white rounded-lg shadow-sm p-4 md:p-5 flex flex-col md:flex-row gap-4 justify-between items-center">
        <h3 class="font-medium text-lg flex items-center gap-2">
          <i class="fa fa-book text-primary"></i> åˆ›ä¸šèµ„æ–™çŸ¥è¯†åº“
        </h3>
        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
          <button id="upload-knowledge-btn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center gap-2 w-full sm:w-auto">
            <i class="fa fa-upload"></i> ä¸Šä¼ èµ„æ–™
          </button>
          <div class="relative w-full sm:w-64">
            <input type="text" id="search-knowledge" class="w-full px-3 py-2 pl-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary text-sm" placeholder="æœç´¢èµ„æ–™æ ‡é¢˜/ç±»å‹">
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral text-sm"></i>
          </div>
        </div>
      </div>

      <!-- èµ„æ–™åˆ—è¡¨ -->
      <div id="knowledge-list" class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- èµ„æ–™å¡ç‰‡åŠ¨æ€ç”Ÿæˆ -->
        <div class="col-span-full text-center text-neutral py-10">
          çŸ¥è¯†åº“æš‚æ— èµ„æ–™ï¼Œå¿«æ¥ä¸Šä¼ ç¬¬ä¸€æ¡åˆ›ä¸šèµ„æ–™å§ï¼
        </div>
      </div>
    </section>
  </main>

  <!-- ç»“æŸè®¨è®ºæ€»ç»“å¼¹çª— -->
  <div id="summary-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
      <h3 class="font-medium text-lg mb-4 flex items-center gap-2">
        <i class="fa fa-pencil text-primary"></i> ç»“æŸè®¨è®º - æ’°å†™æ€»ç»“
      </h3>
      <form id="summary-form">
        <textarea id="summary-content" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary min-h-[150px] mb-4" placeholder="è¯·æ€»ç»“æœ¬æ¬¡è®¨è®ºçš„æ ¸å¿ƒè§‚ç‚¹ã€è¾¾æˆçš„å…±è¯†ã€å¾…è§£å†³çš„é—®é¢˜ç­‰..." required></textarea>
        <div class="flex gap-3 justify-end">
          <button type="button" id="cancel-summary-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">å–æ¶ˆ</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">ç¡®è®¤æäº¤å¹¶å­˜æ¡£</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ä¸Šä¼ çŸ¥è¯†åº“èµ„æ–™å¼¹çª— -->
  <div id="upload-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
      <h3 class="font-medium text-lg mb-4 flex items-center gap-2">
        <i class="fa fa-cloud-upload text-primary"></i> ä¸Šä¼ åˆ›ä¸šèµ„æ–™
      </h3>
      <form id="upload-form">
        <div class="space-y-3 mb-4">
          <div>
            <label class="block text-sm font-medium text-dark mb-1">èµ„æ–™æ ‡é¢˜</label>
            <input type="text" id="upload-title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary" placeholder="å¦‚ï¼šåˆ›ä¸šèèµ„è®¡åˆ’ä¹¦æ¨¡æ¿" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-dark mb-1">èµ„æ–™ç±»å‹</label>
            <select id="upload-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary" required>
              <option value="">-- è¯·é€‰æ‹©ç±»å‹ --</option>
              <option value="æ¨¡æ¿">è®¡åˆ’ä¹¦æ¨¡æ¿</option>
              <option value="è¡Œä¸šæŠ¥å‘Š">è¡Œä¸šæŠ¥å‘Š</option>
              <option value="æ”¿ç­–æ–‡ä»¶">åˆ›ä¸šæ”¿ç­–</option>
              <option value="æ¡ˆä¾‹åˆ†æ">æˆåŠŸæ¡ˆä¾‹</option>
              <option value="å…¶ä»–">å…¶ä»–èµ„æ–™</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-dark mb-1">èµ„æ–™å†…å®¹/é“¾æ¥</label>
            <textarea id="upload-content" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary min-h-[100px]" placeholder="å¯è¾“å…¥èµ„æ–™è¯¦æƒ…ã€æ–‡æ¡£é“¾æ¥ã€ç½‘ç›˜åœ°å€ç­‰..." required></textarea>
          </div>
        </div>
        <div class="flex gap-3 justify-end">
          <button type="button" id="cancel-upload-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">å–æ¶ˆ</button>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">ç¡®è®¤ä¸Šä¼ </button>
        </div>
      </form>
    </div>
  </div>

  <!-- èµ„æ–™æŸ¥çœ‹å¼¹çª— -->
  <div id="view-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 id="view-title" class="font-medium text-lg"></h3>
        <button id="close-view-btn" class="text-neutral hover:text-red-500">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="mb-3 flex items-center gap-2 text-sm">
        <span class="text-neutral">èµ„æ–™ç±»å‹ï¼š</span>
        <span id="view-type" class="px-2 py-0.5 bg-primary/10 text-primary rounded text-xs"></span>
      </div>
      <div class="mb-3 flex items-center gap-2 text-sm">
        <span class="text-neutral">ä¸Šä¼ äººï¼š</span>
        <span id="view-author"></span>
      </div>
      <div class="mb-3 flex items-center gap-2 text-sm">
        <span class="text-neutral">ä¸Šä¼ æ—¶é—´ï¼š</span>
        <span id="view-time"></span>
      </div>
      <div class="border-t border-gray-200 pt-3">
        <h4 class="font-medium text-sm mb-2">èµ„æ–™å†…å®¹ï¼š</h4>
        <div id="view-content" class="text-sm leading-relaxed whitespace-pre-line"></div>
      </div>
    </div>
  </div>

  <!-- æ™ºèƒ½ä½“æµ®åŠ¨çª— -->
  <div id="agent-float" class="fixed bottom-4 right-4 z-40">
    <div id="agent-float-content" class="bg-white rounded-lg shadow-lg w-80 max-h-[500px] overflow-hidden hidden">
      <div class="bg-primary text-white p-3 flex justify-between items-center cursor-pointer" id="agent-float-header">
        <div class="flex items-center gap-2">
          <i class="fa fa-robot"></i>
          <span class="font-medium text-sm">åˆ›ä¸šæ™ºèƒ½ä½“</span>
        </div>
        <i class="fa fa-chevron-down text-sm transition-transform" id="agent-float-icon"></i>
      </div>
      <div id="agent-float-body" class="p-4 overflow-y-auto max-h-[400px]">
        <div id="agent-records" class="space-y-3">
          <div class="text-center text-neutral text-sm py-4">
            æ™ºèƒ½ä½“å°†è‡ªåŠ¨è®°å½•æ¯æ¬¡è®®é¢˜è®¨è®ºå¹¶ç”Ÿæˆä¸“ä¸šæŒ‡å¯¼å»ºè®®
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200">
          <button id="manual-analyze-btn" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
            <i class="fa fa-refresh mr-1"></i> æ‰‹åŠ¨è§¦å‘æ™ºèƒ½ä½“åˆ†æ
          </button>
        </div>
      </div>
    </div>
    <button id="agent-float-toggle" class="bg-primary text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center hover:bg-primary/90 transition-colors">
      <span class="text-2xl">ğŸ¼ğŸ¤˜</span>
    </button>
  </div>

  <!-- ç¼–è¾‘è®¡åˆ’ä¹¦å¼¹çª— -->
  <div id="edit-plan-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-medium text-lg flex items-center gap-2">
          <i class="fa fa-edit text-primary"></i> ç¼–è¾‘åˆ›ä¸šè®¡åˆ’ä¹¦
        </h3>
        <button id="close-edit-plan-btn" class="text-neutral hover:text-red-500">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div id="edit-plan-content" class="flex-1 overflow-y-auto space-y-4">
        <!-- è®¡åˆ’ä¹¦ç« èŠ‚ç¼–è¾‘åŒºåŸŸåŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="mt-4 pt-4 border-t border-gray-200 flex gap-3 justify-end">
        <button id="cancel-edit-plan-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">å–æ¶ˆ</button>
        <button id="save-plan-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">ä¿å­˜è®¡åˆ’ä¹¦</button>
      </div>
    </div>
  </div>

  <script>
    // æœ¬åœ°å­˜å‚¨é”®åå®šä¹‰
    const STORAGE_KEYS = {
      USERS: 'entrepreneurship_platform_users',
      TOPICS: 'entrepreneurship_platform_topics',
      KNOWLEDGE: 'entrepreneurship_platform_knowledge',
      CURRENT_USER: 'entrepreneurship_platform_current_user',
      PROJECT_INFO: 'entrepreneurship_platform_project_info',
      BUSINESS_PLAN: 'entrepreneurship_platform_business_plan'
    };

    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
      initStorage();
      bindEvents();
      checkLoginStatus();
      updateRegisterQuota();
      renderAllData();
    });

    // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºç©ºå¯¹è±¡/æ•°ç»„ï¼‰
    function initStorage() {
      if (!localStorage.getItem(STORAGE_KEYS.USERS)) localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify([]));
      if (!localStorage.getItem(STORAGE_KEYS.TOPICS)) localStorage.setItem(STORAGE_KEYS.TOPICS, JSON.stringify([]));
      if (!localStorage.getItem(STORAGE_KEYS.KNOWLEDGE)) localStorage.setItem(STORAGE_KEYS.KNOWLEDGE, JSON.stringify([]));
      if (!localStorage.getItem(STORAGE_KEYS.PROJECT_INFO)) localStorage.setItem(STORAGE_KEYS.PROJECT_INFO, JSON.stringify({ name: '', description: '' }));
      if (!localStorage.getItem(STORAGE_KEYS.BUSINESS_PLAN)) localStorage.setItem(STORAGE_KEYS.BUSINESS_PLAN, JSON.stringify({
        outline: {
          'é¡¹ç›®æ¦‚è¿°': '',
          'å¸‚åœºåˆ†æ': '',
          'äº§å“/æœåŠ¡ä»‹ç»': '',
          'å•†ä¸šæ¨¡å¼': '',
          'å›¢é˜Ÿä»‹ç»': '',
          'å‘å±•è§„åˆ’': '',
          'è´¢åŠ¡é¢„æµ‹': '',
          'é£é™©åˆ†æ': '',
          'é™„ä»¶èµ„æ–™': ''
        },
        completedSections: []
      }));
    }

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkLoginStatus() {
      const currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_USER));
      if (currentUser) {
        // å·²ç™»å½•
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('navbar').classList.remove('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        document.getElementById('user-name').textContent = currentUser.username;
        switchTab('discuss-tab');
      } else {
        // æœªç™»å½•
        document.getElementById('login-page').classList.remove('hidden');
        document.getElementById('navbar').classList.add('hidden');
        document.getElementById('main-content').classList.add('hidden');
      }
    }

    // æ›´æ–°æ³¨å†Œåé¢
    function updateRegisterQuota() {
      const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS));
      const quota = 7 - users.length;
      document.getElementById('register-quota').textContent = quota;
      // åé¢æ»¡äº†ç¦ç”¨æ³¨å†Œ
      if (quota <= 0) {
        document.getElementById('register-form').querySelector('button[type="submit"]').disabled = true;
        document.getElementById('register-form').querySelector('button[type="submit"]').classList.add('bg-gray-400', 'cursor-not-allowed');
        document.getElementById('register-form').querySelector('button[type="submit"]').classList.remove('bg-primary', 'hover:bg-primary/90');
      }
    }

    // æ ‡ç­¾åˆ‡æ¢
    function switchTab(tabId) {
      // éšè—æ‰€æœ‰tab
      document.querySelectorAll('#main-content > section').forEach(tab => {
        tab.classList.add('hidden');
      });
      // æ˜¾ç¤ºé€‰ä¸­tab
      document.getElementById(tabId).classList.remove('hidden');
      // æ›´æ–°å¯¼èˆªæ é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('#navbar button[id^="tab-"]').forEach(btn => {
        btn.classList.remove('text-primary', 'border-b-2', 'border-primary');
        btn.classList.add('text-neutral');
      });
      document.getElementById(`tab-${tabId.split('-')[0]}`).classList.add('text-primary', 'border-b-2', 'border-primary');
      document.getElementById(`tab-${tabId.split('-')[0]}`).classList.remove('text-neutral');
      
      // åˆ‡æ¢åˆ°åˆ›ä¸šè®¡åˆ’ä¹¦æ—¶æ¸²æŸ“å®Œæ•´å†…å®¹
      if (tabId === 'business-plan-tab') {
        renderFullBusinessPlan();
      }
    }

    // ç»‘å®šæ‰€æœ‰äº‹ä»¶
    function bindEvents() {
      // ç™»å½•/æ³¨å†Œæ ‡ç­¾åˆ‡æ¢
      document.getElementById('login-tab').addEventListener('click', () => {
        document.getElementById('login-tab').classList.add('text-primary', 'border-b-2', 'border-primary');
        document.getElementById('login-tab').classList.remove('text-neutral');
        document.getElementById('register-tab').classList.add('text-neutral');
        document.getElementById('register-tab').classList.remove('text-primary', 'border-b-2', 'border-primary');
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('register-form').classList.add('hidden');
      });
      document.getElementById('register-tab').addEventListener('click', () => {
        document.getElementById('register-tab').classList.add('text-primary', 'border-b-2', 'border-primary');
        document.getElementById('register-tab').classList.remove('text-neutral');
        document.getElementById('login-tab').classList.add('text-neutral');
        document.getElementById('login-tab').classList.remove('text-primary', 'border-b-2', 'border-primary');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('login-form').classList.add('hidden');
      });

      // æ³¨å†Œè¡¨å•æäº¤
      document.getElementById('register-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value.trim();
        const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS));
        
        // éªŒè¯ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if (users.some(user => user.username === username)) {
          alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·æ›´æ¢ï¼');
          return;
        }
        
        // éªŒè¯åé¢
        if (users.length >= 7) {
          alert('æ³¨å†Œåé¢å·²æ»¡ï¼ˆä»…é™7äººï¼‰ï¼Œæ— æ³•æ³¨å†Œï¼');
          return;
        }
        
        // éªŒè¯å¯†ç æ˜¯å¦ä¸º1020
        if (password !== '1020') {
          alert('æ³¨å†Œå¯†ç é”™è¯¯ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„æ³¨å†Œå¯†ç ï¼');
          return;
        }
        
        // æ·»åŠ æ–°ç”¨æˆ·
        users.push({ username, password });
        localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(users));
        // è‡ªåŠ¨ç™»å½•
        localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify({ username }));
        alert('æ³¨å†ŒæˆåŠŸï¼');
        updateRegisterQuota();
        checkLoginStatus();
        this.reset();
      });

      // ç™»å½•è¡¨å•æäº¤
      document.getElementById('login-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS));
        
        // éªŒè¯ç”¨æˆ·
        const user = users.find(user => user.username === username && user.password === password);
        if (user) {
          localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify({ username }));
          alert('ç™»å½•æˆåŠŸï¼');
          checkLoginStatus();
          this.reset();
        } else {
          alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼');
        }
      });

      // é€€å‡ºç™»å½•
      document.getElementById('logout-btn').addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
          localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
          checkLoginStatus();
        }
      });

      // å¯¼èˆªæ æ ‡ç­¾åˆ‡æ¢
      document.getElementById('tab-discuss').addEventListener('click', () => switchTab('discuss-tab'));
      document.getElementById('tab-business-plan').addEventListener('click', () => switchTab('business-plan-tab'));
      document.getElementById('tab-knowledge').addEventListener('click', () => switchTab('knowledge-tab'));

      // å‘èµ·æ–°è®®é¢˜
      document.getElementById('new-topic-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const title = document.getElementById('topic-title').value.trim();
        const content = document.getElementById('topic-content').value.trim();
        const currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_USER));
        const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
        
        // ç”Ÿæˆæ–°è®®é¢˜
        const newTopic = {
          id: Date.now().toString(),
          title,
          content,
          founder: currentUser.username,
          status: 'active', // active: è¿›è¡Œä¸­, archived: å·²å­˜æ¡£
          messages: [
            {
              sender: currentUser.username,
              content,
              time: formatTime(new Date()),
              isFounder: true
            }
          ],
          summary: '',
          createTime: formatTime(new Date()),
          endTime: '',
          businessPlan: {},
          agentRecords: []
        };
        
        topics.unshift(newTopic);
        localStorage.setItem(STORAGE_KEYS.TOPICS, JSON.stringify(topics));
        alert('è®®é¢˜å‘èµ·æˆåŠŸï¼');
        this.reset();
        renderTopics('active');
        // è‡ªåŠ¨æ‰“å¼€æ–°è®®é¢˜
        openChat(newTopic.id);
      });

      // è®®é¢˜åˆ—è¡¨åˆ‡æ¢ï¼ˆè¿›è¡Œä¸­/å·²å­˜æ¡£ï¼‰
      document.getElementById('active-topics').addEventListener('click', () => {
        document.getElementById('active-topics').classList.add('text-primary', 'border-b', 'border-primary');
        document.getElementById('active-topics').classList.remove('text-neutral');
        document.getElementById('archive-topics').classList.add('text-neutral');
        document.getElementById('archive-topics').classList.remove('text-primary', 'border-b', 'border-primary');
        renderTopics('active');
      });
      document.getElementById('archive-topics').addEventListener('click', () => {
        document.getElementById('archive-topics').classList.add('text-primary', 'border-b', 'border-primary');
        document.getElementById('archive-topics').classList.remove('text-neutral');
        document.getElementById('active-topics').classList.add('text-neutral');
        document.getElementById('active-topics').classList.remove('text-primary', 'border-b', 'border-primary');
        renderTopics('archived');
      });

      // å‘é€ç•™è¨€
      document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const content = document.getElementById('message-content').value.trim();
        const currentTopicId = sessionStorage.getItem('current_topic_id');
        if (!currentTopicId) {
          alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¨è®ºè®®é¢˜ï¼');
          return;
        }
        
        const currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_USER));
        const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
        const topicIndex = topics.findIndex(t => t.id === currentTopicId);
        
        if (topicIndex === -1) return;
        
        // æ·»åŠ æ–°ç•™è¨€
        topics[topicIndex].messages.push({
          sender: currentUser.username,
          content,
          time: formatTime(new Date()),
          isFounder: currentUser.username === topics[topicIndex].founder
        });
        
        localStorage.setItem(STORAGE_KEYS.TOPICS, JSON.stringify(topics));
        renderChatMessages(currentTopicId);
        this.reset();
        // æ»šåŠ¨åˆ°åº•éƒ¨
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      // ç»“æŸè®¨è®ºæŒ‰é’®
      document.getElementById('end-discuss-btn').addEventListener('click', function() {
        document.getElementById('summary-modal').classList.remove('hidden');
      });

      // å–æ¶ˆæ€»ç»“
      document.getElementById('cancel-summary-btn').addEventListener('click', function() {
        document.getElementById('summary-modal').classList.add('hidden');
        document.getElementById('summary-form').reset();
      });

      // æäº¤æ€»ç»“å¹¶å­˜æ¡£
      document.getElementById('summary-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const summary = document.getElementById('summary-content').value.trim();
        const currentTopicId = sessionStorage.getItem('current_topic_id');
        if (!currentTopicId) return;
        
        const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
        const topicIndex = topics.findIndex(t => t.id === currentTopicId);
        
        if (topicIndex === -1) return;
        
        // æ›´æ–°è®®é¢˜çŠ¶æ€
        topics[topicIndex].status = 'archived';
        topics[topicIndex].summary = summary;
        topics[topicIndex].endTime = formatTime(new Date());
        
        localStorage.setItem(STORAGE_KEYS.TOPICS, JSON.stringify(topics));
        document.getElementById('summary-modal').classList.add('hidden');
        this.reset();
        alert('è®¨è®ºå·²ç»“æŸå¹¶å­˜æ¡£ï¼Œæ€»ç»“å·²ä¿å­˜ï¼æ™ºèƒ½ä½“æ­£åœ¨è‡ªåŠ¨åˆ†æ...');
        // åˆ·æ–°é¡µé¢
        renderTopics('active');
        document.getElementById('chat-area').classList.add('hidden');
        switchTab('discuss-tab');
        // è‡ªåŠ¨è§¦å‘æ™ºèƒ½ä½“åˆ†æ
        triggerAgentAnalysis(currentTopicId);
      });

      // æ™ºèƒ½ä½“æµ®åŠ¨çª—åˆ‡æ¢
      document.getElementById('agent-float-toggle').addEventListener('click', function() {
        const content = document.getElementById('agent-float-content');
        const icon = document.getElementById('agent-float-icon');
        content.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
      });

      // æ™ºèƒ½ä½“æµ®åŠ¨çª—å¤´éƒ¨åˆ‡æ¢
      document.getElementById('agent-float-header').addEventListener('click', function() {
        const body = document.getElementById('agent-float-body');
        const icon = document.getElementById('agent-float-icon');
        body.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
      });

      // æ‰‹åŠ¨è§¦å‘æ™ºèƒ½ä½“åˆ†æ
      document.getElementById('manual-analyze-btn').addEventListener('click', function() {
        const currentTopicId = sessionStorage.getItem('current_topic_id');
        if (!currentTopicId) {
          alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¨è®ºè®®é¢˜ï¼');
          return;
        }
        triggerAgentAnalysis(currentTopicId);
      });

      // åˆ›ä¸šè®¡åˆ’ä¹¦åˆ‡æ¢
      document.getElementById('business-plan-toggle').addEventListener('click', function() {
        const content = document.getElementById('business-plan-content');
        const icon = document.getElementById('plan-toggle-icon');
        content.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
      });

      // ç¼–è¾‘è®¡åˆ’ä¹¦æŒ‰é’®
      document.getElementById('edit-plan-btn').addEventListener('click', function() {
        openEditPlanModal();
      });

      // å®Œæ•´è®¡åˆ’ä¹¦é¡µé¢ - ç¼–è¾‘æŒ‰é’®
      document.getElementById('edit-full-plan-btn').addEventListener('click', function() {
        openEditPlanModal();
      });

      // å…³é—­ç¼–è¾‘è®¡åˆ’ä¹¦å¼¹çª—
      document.getElementById('close-edit-plan-btn').addEventListener('click', function() {
        document.getElementById('edit-plan-modal').classList.add('hidden');
      });

      // å–æ¶ˆç¼–è¾‘è®¡åˆ’ä¹¦
      document.getElementById('cancel-edit-plan-btn').addEventListener('click', function() {
        document.getElementById('edit-plan-modal').classList.add('hidden');
      });

      // ä¿å­˜è®¡åˆ’ä¹¦
      document.getElementById('save-plan-btn').addEventListener('click', function() {
        saveBusinessPlan();
      });

      // çŸ¥è¯†åº“ - ä¸Šä¼ èµ„æ–™æŒ‰é’®
      document.getElementById('upload-knowledge-btn').addEventListener('click', function() {
        document.getElementById('upload-modal').classList.remove('hidden');
      });

      // å–æ¶ˆä¸Šä¼ 
      document.getElementById('cancel-upload-btn').addEventListener('click', function() {
        document.getElementById('upload-modal').classList.add('hidden');
        document.getElementById('upload-form').reset();
      });

      // æäº¤ä¸Šä¼ èµ„æ–™
      document.getElementById('upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const title = document.getElementById('upload-title').value.trim();
        const type = document.getElementById('upload-type').value;
        const content = document.getElementById('upload-content').value.trim();
        const currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_USER));
        const knowledgeList = JSON.parse(localStorage.getItem(STORAGE_KEYS.KNOWLEDGE));
        
        // ç”Ÿæˆæ–°èµ„æ–™
        const newKnowledge = {
          id: Date.now().toString(),
          title,
          type,
          content,
          author: currentUser.username,
          time: formatTime(new Date())
        };
        
        knowledgeList.unshift(newKnowledge);
        localStorage.setItem(STORAGE_KEYS.KNOWLEDGE, JSON.stringify(knowledgeList));
        document.getElementById('upload-modal').classList.add('hidden');
        this.reset();
        alert('èµ„æ–™ä¸Šä¼ æˆåŠŸï¼');
        renderKnowledgeList();
      });

      // æœç´¢çŸ¥è¯†åº“
      document.getElementById('search-knowledge').addEventListener('input', function() {
        const keyword = this.value.trim().toLowerCase();
        renderKnowledgeList(keyword);
      });

      // å…³é—­æŸ¥çœ‹èµ„æ–™å¼¹çª—
      document.getElementById('close-view-btn').addEventListener('click', function() {
        document.getElementById('view-modal').classList.add('hidden');
      });
    }

    // æ¸²æŸ“è®®é¢˜åˆ—è¡¨
    function renderTopics(status) {
      const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
      const filteredTopics = topics.filter(t => t.status === status);
      const topicsList = document.getElementById('topics-list');
      const currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_USER));
      
      if (filteredTopics.length === 0) {
        topicsList.innerHTML = `<div class="text-center text-neutral py-10">æš‚æ— ${status === 'active' ? 'è¿›è¡Œä¸­' : 'å·²å­˜æ¡£'}çš„è®®é¢˜</div>`;
        return;
      }
      
      topicsList.innerHTML = '';
      filteredTopics.forEach(topic => {
        const topicItem = document.createElement('div');
        topicItem.className = 'p-3 border-b border-gray-100 hover:bg-secondary/30 transition-colors';
        const isFounder = currentUser && currentUser.username === topic.founder;
        topicItem.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1 topic-content">
              <h4 class="font-medium text-sm truncate">${topic.title}</h4>
              <p class="text-xs text-neutral truncate mt-1">å‘èµ·äººï¼š${topic.founder}</p>
              <p class="text-xs text-neutral mt-1">${status === 'active' ? 'åˆ›å»ºæ—¶é—´ï¼š' : 'ç»“æŸæ—¶é—´ï¼š'}${topic[status === 'active' ? 'createTime' : 'endTime']}</p>
              <p class="text-xs text-neutral mt-1">ç•™è¨€æ•°ï¼š${topic.messages.length}</p>
            </div>
            ${isFounder ? `<button class="delete-topic-btn text-red-500 hover:text-red-700 text-xs px-2 py-1 border border-red-300 rounded hover:bg-red-50 transition-colors" data-id="${topic.id}">åˆ é™¤</button>` : ''}
          </div>
        `;
        topicItem.querySelector('.topic-content').addEventListener('click', () => openChat(topic.id));
        topicsList.appendChild(topicItem);
      });
      
      // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
      document.querySelectorAll('.delete-topic-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const topicId = this.getAttribute('data-id');
          deleteTopic(topicId);
        });
      });
    }

    // åˆ é™¤è®®é¢˜
    function deleteTopic(topicId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®®é¢˜å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) return;
      
      const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
      const topicIndex = topics.findIndex(t => t.id === topicId);
      
      if (topicIndex === -1) return;
      
      topics.splice(topicIndex, 1);
      localStorage.setItem(STORAGE_KEYS.TOPICS, JSON.stringify(topics));
      
      // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¿™ä¸ªè®®é¢˜ï¼Œå…³é—­èŠå¤©åŒº
      const currentTopicId = sessionStorage.getItem('current_topic_id');
      if (currentTopicId === topicId) {
        document.getElementById('chat-area').classList.add('hidden');
        sessionStorage.removeItem('current_topic_id');
      }
      
      alert('è®®é¢˜åˆ é™¤æˆåŠŸï¼');
      renderTopics('active');
      renderTopics('archived');
    }

    // æ‰“å¼€èŠå¤©çª—å£
    function openChat(topicId) {
      const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
      const topic = topics.find(t => t.id === topicId);
      if (!topic) return;
      
      // ä¿å­˜å½“å‰è®®é¢˜ID
      sessionStorage.setItem('current_topic_id', topicId);
      // æ˜¾ç¤ºèŠå¤©åŒº
      document.getElementById('chat-area').classList.remove('hidden');
      // æ›´æ–°è®®é¢˜æ ‡é¢˜å’ŒçŠ¶æ€
      document.getElementById('chat-topic-title').textContent = topic.title;
      document.getElementById('chat-topic-status').textContent = topic.status === 'active' ? 'è®¨è®ºä¸­' : 'å·²å­˜æ¡£';
      document.getElementById('chat-topic-status').className = `text-xs px-2 py-1 rounded-full ${topic.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`;
      // æ¸²æŸ“èŠå¤©æ¶ˆæ¯
      renderChatMessages(topicId);
      // æ¸²æŸ“åˆ›ä¸šè®¡åˆ’ä¹¦
      renderBusinessPlan();
      // æ¸²æŸ“æ™ºèƒ½ä½“è®°å½•
      renderAgentRecords(topicId);
      // æ§åˆ¶å‘èµ·äººæ“ä½œåŒºæ˜¾ç¤º
      const currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_USER));
      if (currentUser.username === topic.founder && topic.status === 'active') {
        document.getElementById('founder-actions').classList.remove('hidden');
      } else {
        document.getElementById('founder-actions').classList.add('hidden');
      }
      // ç¦ç”¨/å¯ç”¨ç•™è¨€æ¡†
      document.getElementById('message-content').disabled = topic.status !== 'active';
      document.getElementById('message-form').querySelector('button[type="submit"]').disabled = topic.status !== 'active';
      if (topic.status !== 'active') {
        document.getElementById('message-form').querySelector('button[type="submit"]').classList.add('bg-gray-400', 'cursor-not-allowed');
        document.getElementById('message-form').querySelector('button[type="submit"]').classList.remove('bg-primary', 'hover:bg-primary/90');
      } else {
        document.getElementById('message-form').querySelector('button[type="submit"]').classList.remove('bg-gray-400', 'cursor-not-allowed');
        document.getElementById('message-form').querySelector('button[type="submit"]').classList.add('bg-primary', 'hover:bg-primary/90');
      }
    }

    // æ¸²æŸ“èŠå¤©æ¶ˆæ¯ï¼ˆå¾®ä¿¡å¼ï¼‰
    function renderChatMessages(topicId) {
      const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
      const topic = topics.find(t => t.id === topicId);
      if (!topic) return;
      
      const chatMessages = document.getElementById('chat-messages');
      const currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_USER));
      
      chatMessages.innerHTML = '';
      topic.messages.forEach(msg => {
        const isSelf = msg.sender === currentUser.username;
        const messageItem = document.createElement('div');
        messageItem.className = `flex ${isSelf ? 'justify-end' : 'justify-start'} items-start gap-2 mb-2`;
        messageItem.innerHTML = `
          <div class="${isSelf ? 'order-2' : 'order-1'} ${isSelf ? 'chat-bubble-right' : 'chat-bubble-left'}">
            <div class="text-xs ${isSelf ? 'text-white/80' : 'text-neutral'} mb-1">${msg.sender} ${msg.isFounder ? '(å‘èµ·äºº)' : ''}</div>
            <div class="break-words">${msg.content.replace(/\n/g, '<br>')}</div>
            <div class="text-xs ${isSelf ? 'text-white/80' : 'text-neutral'} mt-1 text-right">${msg.time}</div>
          </div>
          <div class="${isSelf ? 'order-1' : 'order-2'} w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white text-xs">
            ${msg.sender.charAt(0)}
          </div>
        `;
        chatMessages.appendChild(messageItem);
      });
      
      // å¦‚æœæœ‰æ€»ç»“ï¼Œæ·»åŠ æ€»ç»“æ¨¡å—
      if (topic.summary) {
        const summaryItem = document.createElement('div');
        summaryItem.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-r-lg my-4';
        summaryItem.innerHTML = `
          <h4 class="font-medium text-sm text-yellow-800 mb-1">æœ¬æ¬¡è®¨è®ºæ€»ç»“</h4>
          <div class="text-sm text-dark break-words">${topic.summary.replace(/\n/g, '<br>')}</div>
          <div class="text-xs text-neutral mt-1">æ€»ç»“æ—¶é—´ï¼š${topic.endTime}</div>
        `;
        chatMessages.appendChild(summaryItem);
      }
    }

    // æ›´æ–°æ™ºèƒ½ä½“ä¸‹æ‹‰é€‰é¡¹
    function updateAgentSelects() {
      const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
      const knowledgeList = JSON.parse(localStorage.getItem(STORAGE_KEYS.KNOWLEDGE));
      const topicSelect = document.getElementById('agent-topic');
      const knowledgeSelect = document.getElementById('agent-knowledge');
      
      // æ¸…ç©ºåŸæœ‰é€‰é¡¹
      topicSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©è®®é¢˜ï¼ˆå¯é€‰ï¼‰ --</option>';
      knowledgeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©èµ„æ–™ï¼ˆå¯é€‰ï¼‰ --</option>';
      
      // æ·»åŠ è®®é¢˜é€‰é¡¹
      topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.id;
        option.textContent = topic.title;
        topicSelect.appendChild(option);
      });
      
      // æ·»åŠ çŸ¥è¯†åº“é€‰é¡¹
      knowledgeList.forEach(knowledge => {
        const option = document.createElement('option');
        option.value = knowledge.id;
        option.textContent = knowledge.title;
        knowledgeSelect.appendChild(option);
      });
    }

    // ç”Ÿæˆæ™ºèƒ½ä½“ç»“æœ
    function generateAgentResult(type) {
      const topicId = document.getElementById('agent-topic').value;
      const knowledgeId = document.getElementById('agent-knowledge').value;
      const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
      const knowledgeList = JSON.parse(localStorage.getItem(STORAGE_KEYS.KNOWLEDGE));
      const currentTopic = topicId ? topics.find(t => t.id === topicId) : null;
      const currentKnowledge = knowledgeId ? knowledgeList.find(k => k.id === knowledgeId) : null;
      
      const resultContent = document.getElementById('agent-result-content');
      const resultTitle = document.getElementById('agent-result-title');
      
      // åŠ è½½çŠ¶æ€
      resultContent.innerHTML = `<div class="text-center text-neutral py-10"><i class="fa fa-spinner fa-spin mr-2"></i>æ™ºèƒ½ä½“æ­£åœ¨åˆ†æç”Ÿæˆç»“æœï¼Œè¯·ç¨å€™...</div>`;
      
      // æ¨¡æ‹Ÿå¼‚æ­¥ç”Ÿæˆï¼ˆå®é™…é¡¹ç›®å¯å¯¹æ¥AIæ¥å£ï¼‰
      setTimeout(() => {
        let result = '';
        if (type === 'plan') {
          resultTitle.textContent = 'åˆ›ä¸šè®¡åˆ’ä¹¦ï¼ˆæ™ºèƒ½ç”Ÿæˆï¼‰';
          result = `# åˆ›ä¸šè®¡åˆ’ä¹¦
## åŸºç¡€ä¿¡æ¯
- å…³è”è®®é¢˜ï¼š${currentTopic ? currentTopic.title : 'æ— '}
- å‚è€ƒèµ„æ–™ï¼š${currentKnowledge ? `${currentKnowledge.title}ï¼ˆ${currentKnowledge.type}ï¼‰` : 'æ— '}
- ç”Ÿæˆæ—¶é—´ï¼š${formatTime(new Date())}

## ä¸€ã€é¡¹ç›®æ¦‚è¿°
${currentTopic ? currentTopic.content : 'æœ¬é¡¹ç›®èšç„¦äºæ–°å…´åˆ›ä¸šèµ›é“ï¼Œä¾æ‰˜è¡Œä¸šå‘å±•è¶‹åŠ¿ï¼Œç»“åˆå¸‚åœºéœ€æ±‚ï¼Œæ‰“é€ å…·æœ‰æ ¸å¿ƒç«äº‰åŠ›çš„åˆ›ä¸šé¡¹ç›®ï¼Œè‡´åŠ›äºè§£å†³è¡Œä¸šç—›ç‚¹ï¼Œåˆ›é€ ç¤¾ä¼šä¸å•†ä¸šä»·å€¼ã€‚'}

## äºŒã€å¸‚åœºåˆ†æ
### 1. è¡Œä¸šç°çŠ¶
å½“å‰è¡Œä¸šå¤„äº${currentTopic ? 'å¿«é€Ÿå‘å±•' : 'ç¨³æ­¥å¢é•¿'}é˜¶æ®µï¼Œå¸‚åœºè§„æ¨¡æŒç»­æ‰©å¤§ï¼Œæ”¿ç­–æ”¯æŒåŠ›åº¦åŠ å¤§ï¼Œä¸ºåˆ›ä¸šé¡¹ç›®æä¾›äº†è‰¯å¥½çš„å‘å±•ç¯å¢ƒã€‚
### 2. ç›®æ ‡ç”¨æˆ·
æ ¸å¿ƒç›®æ ‡ç”¨æˆ·ä¸º${currentTopic ? 'ä¸­é’å¹´åˆ›ä¸šç¾¤ä½“/ä¸­å°ä¼ä¸šä¸»' : 'ç²¾å‡†å®šä½çš„æ¶ˆè´¹ç¾¤ä½“/è¡Œä¸šå®¢æˆ·'}ï¼Œå…·æœ‰æ˜ç¡®çš„éœ€æ±‚ç—›ç‚¹å’Œä»˜è´¹æ„æ„¿ã€‚
### 3. ç«äº‰æ ¼å±€
å¸‚åœºç«äº‰${currentTopic ? 'è¾ƒä¸ºæ¿€çƒˆ' : 'ç›¸å¯¹æ¸©å’Œ'}ï¼Œä¸»è¦ç«äº‰å¯¹æ‰‹ä¸ºä¼ ç»Ÿä¼ä¸šå’Œæ–°å…´åˆ›ä¸šå…¬å¸ï¼Œæœ¬é¡¹ç›®å°†é€šè¿‡å·®å¼‚åŒ–ç«äº‰ç­–ç•¥å»ºç«‹æ ¸å¿ƒä¼˜åŠ¿ã€‚

## ä¸‰ã€äº§å“/æœåŠ¡ä»‹ç»
æœ¬é¡¹ç›®æ ¸å¿ƒäº§å“/æœåŠ¡ä¸º${currentTopic ? 'åŸºäºåˆ›ä¸šè®®é¢˜çš„è§£å†³æ–¹æ¡ˆ' : 'ä¸ªæ€§åŒ–/æ ‡å‡†åŒ–çš„äº§å“/æœåŠ¡'}ï¼Œå…·æœ‰${currentKnowledge ? 'å‚è€ƒè¡Œä¸šå…ˆè¿›ç»éªŒæ‰“é€ çš„' : 'è‡ªä¸»ç ”å‘çš„'}æ ¸å¿ƒåŠŸèƒ½ï¼Œèƒ½å¤Ÿæœ‰æ•ˆè§£å†³ç”¨æˆ·ç—›ç‚¹ï¼Œæä¾›è¶…é¢„æœŸçš„ä½¿ç”¨ä½“éªŒã€‚

## å››ã€å•†ä¸šæ¨¡å¼
### 1. ç›ˆåˆ©æ¨¡å¼
ä¸»è¦é‡‡ç”¨${currentTopic ? 'æœåŠ¡è´¹/åŠ ç›Ÿè´¹' : 'äº§å“é”€å”®/ä¼šå‘˜è®¢é˜…/å¹¿å‘Šå˜ç°'}ç­‰ç›ˆåˆ©æ¨¡å¼ï¼Œç›ˆåˆ©ç‚¹æ¸…æ™°ï¼Œå˜ç°èƒ½åŠ›å¼ºã€‚
### 2. è¿è¥æ¨¡å¼
é‡‡ç”¨${currentKnowledge ? 'è½»èµ„äº§è¿è¥' : 'çº¿ä¸Šçº¿ä¸‹ç»“åˆ'}çš„è¿è¥æ¨¡å¼ï¼Œé™ä½è¿è¥æˆæœ¬ï¼Œæé«˜è¿è¥æ•ˆç‡ï¼Œå¿«é€Ÿå®ç°è§„æ¨¡åŒ–æ‰©å¼ ã€‚

## äº”ã€å›¢é˜Ÿä»‹ç»
æ ¸å¿ƒå›¢é˜Ÿç”±${currentTopic ? 'åˆ›ä¸šé¢†åŸŸèµ„æ·±ä»ä¸šè€…' : 'è·¨é¢†åŸŸä¸“ä¸šäººæ‰'}ç»„æˆï¼Œå…·å¤‡ä¸°å¯Œçš„è¡Œä¸šç»éªŒã€æŠ€æœ¯èƒ½åŠ›å’Œç®¡ç†ç»éªŒï¼Œå›¢é˜Ÿç»“æ„åˆç†ï¼Œäº’è¡¥æ€§å¼ºï¼Œä¸ºé¡¹ç›®æˆåŠŸæä¾›äº†åšå®çš„äººæ‰ä¿éšœã€‚

## å…­ã€å‘å±•è§„åˆ’
### 1. çŸ­æœŸè§„åˆ’ï¼ˆ1å¹´å†…ï¼‰
å®Œæˆäº§å“/æœåŠ¡æ‰“ç£¨ï¼Œå®ç°ç§å­ç”¨æˆ·ç§¯ç´¯ï¼Œåˆæ­¥å»ºç«‹å¸‚åœºè®¤çŸ¥ï¼Œå®ç°æ”¶æ”¯å¹³è¡¡ã€‚
### 2. ä¸­æœŸè§„åˆ’ï¼ˆ1-3å¹´ï¼‰
æ‰©å¤§å¸‚åœºè§„æ¨¡ï¼Œæå‡å“ç‰Œå½±å“åŠ›ï¼Œå®Œæˆå¤šè½®èèµ„ï¼Œå®ç°åŒºåŸŸåŒ–æ‰©å¼ ã€‚
### 3. é•¿æœŸè§„åˆ’ï¼ˆ3å¹´ä»¥ä¸Šï¼‰
æˆä¸ºè¡Œä¸šé¢†å†›ä¼ä¸šï¼Œå®ç°å…¨å›½åŒ–å¸ƒå±€ï¼Œæ‰“é€ çŸ¥åå“ç‰Œï¼Œæ¢ç´¢å¤šå…ƒåŒ–å‘å±•è·¯å¾„ã€‚

## ä¸ƒã€è´¢åŠ¡é¢„æµ‹
### 1. å¯åŠ¨èµ„é‡‘
é¢„è®¡å¯åŠ¨èµ„é‡‘${currentTopic ? '50-100' : '20-50'}ä¸‡å…ƒï¼Œä¸»è¦ç”¨äºäº§å“ç ”å‘ã€å¸‚åœºæ¨å¹¿ã€å›¢é˜Ÿå»ºè®¾ç­‰ã€‚
### 2. æ”¶å…¥é¢„æµ‹
ç¬¬ä¸€å¹´é¢„è®¡å®ç°è¥ä¸šæ”¶å…¥${currentTopic ? '100-200' : '50-100'}ä¸‡å…ƒï¼Œå¹´å¤åˆå¢é•¿ç‡ä¸ä½äº${currentKnowledge ? '80%' : '50%'}ã€‚
### 3. æˆæœ¬é¢„æµ‹
ä¸»è¦æˆæœ¬ä¸ºç ”å‘æˆæœ¬ã€è¥é”€æˆæœ¬ã€äººåŠ›æˆæœ¬ï¼Œé¢„è®¡ç¬¬ä¸€å¹´ç»¼åˆæˆæœ¬æ§åˆ¶åœ¨${currentTopic ? '80-150' : '40-80'}ä¸‡å…ƒã€‚

## å…«ã€é£é™©åˆ†æä¸åº”å¯¹
### 1. å¸‚åœºé£é™©
å¸‚åœºéœ€æ±‚å˜åŒ–ã€ç«äº‰åŠ å‰§ç­‰é£é™©ï¼Œåº”å¯¹ç­–ç•¥ï¼šæŒç»­å…³æ³¨å¸‚åœºåŠ¨æ€ï¼ŒåŠæ—¶è°ƒæ•´äº§å“/æœåŠ¡ç­–ç•¥ï¼ŒåŠ å¼ºå“ç‰Œå»ºè®¾ï¼Œæé«˜ç”¨æˆ·ç²˜æ€§ã€‚
### 2. æŠ€æœ¯é£é™©
æŠ€æœ¯æ›´æ–°è¿­ä»£å¿«ã€æ ¸å¿ƒæŠ€æœ¯æµå¤±ç­‰é£é™©ï¼Œåº”å¯¹ç­–ç•¥ï¼šåŠ å¤§ç ”å‘æŠ•å…¥ï¼Œä¿æŠ¤æ ¸å¿ƒçŸ¥è¯†äº§æƒï¼Œå»ºç«‹æŠ€æœ¯å£å’ã€‚
### 3. èµ„é‡‘é£é™©
èµ„é‡‘é“¾æ–­è£‚ã€èèµ„å›°éš¾ç­‰é£é™©ï¼Œåº”å¯¹ç­–ç•¥ï¼šåˆç†è§„åˆ’èµ„é‡‘ä½¿ç”¨ï¼Œæ‹“å±•å¤šå…ƒåŒ–èèµ„æ¸ é“ï¼Œæ§åˆ¶è¿è¥æˆæœ¬ã€‚

## ä¹ã€é™„ä»¶
${currentKnowledge ? `å‚è€ƒèµ„æ–™ï¼šã€Š${currentKnowledge.title}ã€‹- ${currentKnowledge.author}` : 'æ— '}
${currentTopic ? `è®¨è®ºè®®é¢˜æ ¸å¿ƒè§‚ç‚¹ï¼š${currentTopic.content.substring(0, 200)}...` : ''}
`;
        } else {
          resultTitle.textContent = 'åˆ›ä¸šä¸“ä¸šæŒ‡å¯¼å»ºè®®ï¼ˆæ™ºèƒ½åˆ†æï¼‰';
          result = `# åˆ›ä¸šä¸“ä¸šæŒ‡å¯¼å»ºè®®
## åŸºç¡€ä¿¡æ¯
- å…³è”è®®é¢˜ï¼š${currentTopic ? currentTopic.title : 'æ— '}
- å‚è€ƒèµ„æ–™ï¼š${currentKnowledge ? `${currentKnowledge.title}ï¼ˆ${currentKnowledge.type}ï¼‰` : 'æ— '}
- æŒ‡å¯¼æ—¶é—´ï¼š${formatTime(new Date())}

## ä¸€ã€è®®é¢˜æ ¸å¿ƒåˆ†æ
${currentTopic ? 
  `æœ¬æ¬¡è®®é¢˜ã€Š${currentTopic.title}ã€‹èšç„¦äº${currentTopic.content.substring(0, 100)}...ï¼Œæ ¸å¿ƒæ¢è®¨äº†åˆ›ä¸šè¿‡ç¨‹ä¸­çš„${currentTopic.messages.length > 3 ? 'å¸‚åœºã€èèµ„ã€è¿è¥' : 'æ ¸å¿ƒ'}é—®é¢˜ï¼Œå‚ä¸è®¨è®ºè€…æå‡ºäº†è¯¸å¤šæœ‰ä»·å€¼çš„è§‚ç‚¹ï¼Œæ•´ä½“è®¨è®ºæ–¹å‘æ˜ç¡®ï¼Œå…·æœ‰è¾ƒå¼ºçš„å®é™…æŒ‡å¯¼æ„ä¹‰ã€‚` 
  : 
  'æœ¬æ¬¡æœªå…³è”å…·ä½“è®¨è®ºè®®é¢˜ï¼Œä»¥ä¸‹ä¸ºé€šç”¨åˆ›ä¸šä¸“ä¸šæŒ‡å¯¼å»ºè®®ï¼Œé€‚ç”¨äºå„ç±»åˆ›ä¸šé¡¹ç›®å‰æœŸè§„åˆ’ä¸è¿è¥ã€‚'}

## äºŒã€æ ¸å¿ƒæŒ‡å¯¼å»ºè®®
### 1. é¡¹ç›®å®šä½å±‚é¢
${currentTopic ? 'ç»“åˆæœ¬æ¬¡è®¨è®ºçš„æ ¸å¿ƒè§‚ç‚¹ï¼Œå»ºè®®é¡¹ç›®å®šä½è¿›ä¸€æ­¥èšç„¦ç»†åˆ†èµ›é“ï¼Œé¿å…åŒè´¨åŒ–ç«äº‰ï¼Œæ‰“é€ å·®å¼‚åŒ–æ ¸å¿ƒä¼˜åŠ¿ï¼Œæ˜ç¡®ç›®æ ‡ç”¨æˆ·ç¾¤ä½“çš„ç²¾å‡†éœ€æ±‚ï¼Œåšåˆ°â€œå°è€Œç¾â€ï¼Œå†é€æ­¥å®ç°è§„æ¨¡åŒ–å‘å±•ã€‚' : 'åˆ›ä¸šé¡¹ç›®é¦–å…ˆè¦åšå¥½ç²¾å‡†å®šä½ï¼Œæ˜ç¡®â€œä¸ºè°è§£å†³ä»€ä¹ˆé—®é¢˜â€ï¼Œé¿å…ç›²ç›®è¿›å…¥çº¢æµ·å¸‚åœºï¼Œä¼˜å…ˆé€‰æ‹©æ”¿ç­–æ”¯æŒã€å¸‚åœºéœ€æ±‚å¤§ã€ç«äº‰ç›¸å¯¹è¾ƒå°çš„ç»†åˆ†é¢†åŸŸï¼Œå»ºç«‹æ¸…æ™°çš„é¡¹ç›®å®šä½å’Œå“ç‰Œä¸»å¼ ã€‚'}

### 2. å¸‚åœºè°ƒç ”å±‚é¢
${currentKnowledge && currentKnowledge.type === 'è¡Œä¸šæŠ¥å‘Š' ? 'ç»“åˆå‚è€ƒèµ„æ–™ã€Š${currentKnowledge.title}ã€‹çš„è¡Œä¸šæ•°æ®ï¼Œå»ºè®®è¿›ä¸€æ­¥å¼€å±•å®åœ°å¸‚åœºè°ƒç ”ï¼ŒéªŒè¯å¸‚åœºéœ€æ±‚çš„çœŸå®æ€§å’ŒæŒç»­æ€§ï¼Œåˆ†æç«äº‰å¯¹æ‰‹çš„ä¼˜åŠ£åŠ¿ï¼Œæ€»ç»“è¡Œä¸šå‘å±•è§„å¾‹å’Œè¶‹åŠ¿ï¼Œä¸ºé¡¹ç›®å†³ç­–æä¾›æ•°æ®æ”¯æ’‘ï¼Œé¿å…â€œæ‹è„‘è¢‹â€åšå†³ç­–ã€‚' : 'å¸‚åœºè°ƒç ”æ˜¯åˆ›ä¸šçš„åŸºç¡€ï¼Œå»ºè®®é€šè¿‡çº¿ä¸Šé—®å·ã€çº¿ä¸‹è®¿è°ˆã€ç«å“åˆ†æç­‰å¤šç§æ–¹å¼ï¼Œå…¨é¢äº†è§£è¡Œä¸šç°çŠ¶ã€å¸‚åœºè§„æ¨¡ã€ç”¨æˆ·éœ€æ±‚ã€ç«äº‰æ ¼å±€ï¼Œå½¢æˆè¯¦ç»†çš„å¸‚åœºè°ƒç ”æŠ¥å‘Šï¼Œä½œä¸ºé¡¹ç›®è§„åˆ’çš„é‡è¦ä¾æ®ã€‚'}

### 3. èèµ„è§„åˆ’å±‚é¢
${currentTopic ? 'é’ˆå¯¹æœ¬æ¬¡è®¨è®ºä¸­æåŠçš„èèµ„é—®é¢˜ï¼Œå»ºè®®åˆåˆ›é˜¶æ®µä¼˜å…ˆé€‰æ‹©è‡ªæœ‰èµ„é‡‘ã€å¤©ä½¿æŠ•èµ„ã€åˆ›ä¸šè¡¥è´´ç­‰ä½æˆæœ¬èèµ„æ–¹å¼ï¼Œé¿å…è¿‡æ—©ç¨€é‡Šè‚¡æƒï¼Œèèµ„å‰åšå¥½è¯¦ç»†çš„å•†ä¸šè®¡åˆ’ä¹¦å’Œè´¢åŠ¡é¢„æµ‹ï¼Œæ˜ç¡®èèµ„é‡‘é¢ã€èèµ„ç”¨é€”ã€é€€å‡ºæœºåˆ¶ï¼Œå¯¹æ¥ç²¾å‡†çš„æŠ•èµ„æœºæ„å’ŒæŠ•èµ„äººã€‚' : 'åˆåˆ›ä¼ä¸šèèµ„è¦éµå¾ªâ€œæŒ‰éœ€èèµ„ã€åˆ†æ­¥èèµ„â€çš„åŸåˆ™ï¼Œå‰æœŸä¸è¦è¿½æ±‚å¤§é¢èèµ„ï¼Œé‡ç‚¹å…³æ³¨æŠ•èµ„äººçš„èµ„æºå’Œè¡Œä¸šç»éªŒï¼Œè€Œéå•çº¯çš„èµ„é‡‘æ”¯æŒï¼ŒåŒæ—¶è¦åšå¥½è´¢åŠ¡è§„åˆ’ï¼Œæ§åˆ¶èèµ„æˆæœ¬ï¼Œç¡®ä¿èµ„é‡‘é“¾çš„ç¨³å®šã€‚'}

### 4. å›¢é˜Ÿå»ºè®¾å±‚é¢
${currentTopic ? 'ç»“åˆæœ¬æ¬¡è®¨è®ºçš„å»ºè®®ï¼Œåˆ›ä¸šå›¢é˜Ÿæ˜¯é¡¹ç›®æˆåŠŸçš„æ ¸å¿ƒï¼Œå»ºè®®æ­å»ºç»“æ„åˆç†çš„æ ¸å¿ƒå›¢é˜Ÿï¼Œæ¶µç›–æŠ€æœ¯ã€å¸‚åœºã€è¿è¥ã€ç®¡ç†ç­‰ä¸åŒé¢†åŸŸçš„ä¸“ä¸šäººæ‰ï¼Œæ˜ç¡®å›¢é˜Ÿæˆå‘˜çš„èŒè´£å’Œåˆ†å·¥ï¼Œå»ºç«‹å®Œå–„çš„ç»©æ•ˆè€ƒæ ¸å’Œæ¿€åŠ±æœºåˆ¶ï¼Œå¢å¼ºå›¢é˜Ÿçš„å‡èšåŠ›å’Œæˆ˜æ–—åŠ›ï¼Œé¿å…â€œä¸€è¨€å ‚â€ã€‚' : 'åˆ›ä¸šå›¢é˜Ÿè¦æ³¨é‡äº’è¡¥æ€§å’Œç¨³å®šæ€§ï¼Œæ ¸å¿ƒæˆå‘˜è¦æ‹¥æœ‰å…±åŒçš„ä»·å€¼è§‚å’Œåˆ›ä¸šç›®æ ‡ï¼Œæ˜ç¡®è‚¡æƒåˆ†é…å’Œæƒè´£åˆ©ï¼Œå»ºç«‹è§„èŒƒçš„å›¢é˜Ÿç®¡ç†åˆ¶åº¦ï¼ŒåŒæ—¶è¦æ³¨é‡å›¢é˜Ÿå­¦ä¹ å’Œæˆé•¿ï¼Œæå‡å›¢é˜Ÿçš„æ•´ä½“ä¸“ä¸šèƒ½åŠ›ã€‚'}

### 5. è¿è¥æ‰§è¡Œå±‚é¢
${currentKnowledge && currentKnowledge.type === 'æ¡ˆä¾‹åˆ†æ' ? 'å‚è€ƒã€Š${currentKnowledge.title}ã€‹çš„æˆåŠŸæ¡ˆä¾‹ï¼Œå»ºè®®é¡¹ç›®è¿è¥é‡‡ç”¨â€œç²¾ç›Šåˆ›ä¸šâ€æ¨¡å¼ï¼Œå¿«é€Ÿæ¨å‡ºæœ€å°å¯è¡Œäº§å“ï¼ˆMVPï¼‰ï¼Œé€šè¿‡å¸‚åœºåé¦ˆä¸æ–­è¿­ä»£ä¼˜åŒ–ï¼Œé¿å…è¿‡åº¦ç ”å‘å’Œç›²ç›®æ‰©å¼ ï¼Œæ³¨é‡ç”¨æˆ·ä½“éªŒå’Œå£ç¢‘å»ºè®¾ï¼Œå®ç°â€œå°æ­¥å¿«è·‘ã€å¿«é€Ÿè¿­ä»£â€ã€‚' : 'åˆ›ä¸šé¡¹ç›®è¿è¥è¦æ³¨é‡è½åœ°æ‰§è¡Œï¼Œåˆ¶å®šè¯¦ç»†çš„è¿è¥è®¡åˆ’å’Œé˜¶æ®µç›®æ ‡ï¼Œæ˜ç¡®å…³é”®ç»©æ•ˆæŒ‡æ ‡ï¼ˆKPIï¼‰ï¼ŒåŠ å¼ºè¿‡ç¨‹ç®¡æ§å’Œç»“æœè€ƒæ ¸ï¼ŒåŒæ—¶è¦ä¿æŒçµæ´»æ€§ï¼Œæ ¹æ®å¸‚åœºå˜åŒ–åŠæ—¶è°ƒæ•´è¿è¥ç­–ç•¥ï¼Œå¿«é€Ÿå“åº”ç”¨æˆ·éœ€æ±‚ã€‚'}

## ä¸‰ã€æ³¨æ„äº‹é¡¹
1. åˆ›ä¸šè¿‡ç¨‹ä¸­è¦ä¿æŒç†æ€§ï¼Œé¿å…ç›²ç›®ä¹è§‚ï¼Œåšå¥½é£é™©é¢„åˆ¤å’Œåº”å¯¹æªæ–½ï¼Œå¯¹å¯èƒ½å‡ºç°çš„å¸‚åœºã€æŠ€æœ¯ã€èµ„é‡‘ã€æ”¿ç­–ç­‰é£é™©æå‰åˆ¶å®šè§£å†³æ–¹æ¡ˆï¼›
2. æ³¨é‡çŸ¥è¯†äº§æƒä¿æŠ¤ï¼ŒåŠæ—¶ç”³è¯·å•†æ ‡ã€ä¸“åˆ©ã€è‘—ä½œæƒç­‰ï¼Œå»ºç«‹æŠ€æœ¯å£å’ï¼Œé¿å…æ ¸å¿ƒæŠ€æœ¯å’Œåˆ›æ„è¢«æŠ„è¢­ï¼›
3. éµå®ˆå›½å®¶ç›¸å…³æ³•å¾‹æ³•è§„ï¼Œä¾æ³•ç»è¥ï¼Œè§„èŒƒè´¢åŠ¡ç®¡ç†å’Œç¨åŠ¡ç”³æŠ¥ï¼Œé¿å…æ³•å¾‹é£é™©ï¼›
4. ä¿æŒæŒç»­å­¦ä¹ çš„å¿ƒæ€ï¼Œå…³æ³¨è¡Œä¸šåŠ¨æ€å’Œæ–°æŠ€æœ¯å‘å±•ï¼Œä¸æ–­æå‡è‡ªèº«çš„åˆ›ä¸šèƒ½åŠ›å’Œé¡¹ç›®çš„æ ¸å¿ƒç«äº‰åŠ›ï¼›
5. æ³¨é‡ç”¨æˆ·åé¦ˆï¼ŒæŠŠç”¨æˆ·æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œé€šè¿‡ä¼˜è´¨çš„äº§å“/æœåŠ¡å’Œè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œç§¯ç´¯æ ¸å¿ƒç”¨æˆ·ï¼Œå®ç°å£ç¢‘ä¼ æ’­ã€‚

## å››ã€åç»­è¡ŒåŠ¨å»ºè®®
${currentTopic ? `1. ç»“åˆæœ¬æ¬¡è®¨è®ºæ€»ç»“å’ŒæŒ‡å¯¼å»ºè®®ï¼Œå®Œå–„é¡¹ç›®å•†ä¸šè®¡åˆ’ä¹¦ï¼Œæ˜ç¡®é¡¹ç›®å‘å±•çš„æ ¸å¿ƒè·¯å¾„å’Œé˜¶æ®µç›®æ ‡ï¼›
2. é’ˆå¯¹æœ¬æ¬¡è®¨è®ºä¸­æœªè§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼Œå¯å‘èµ·æ–°çš„ä¸“é¡¹è®¨è®ºï¼Œé‚€è¯·ä¸“ä¸šäººå£«å‚ä¸ï¼Œå½¢æˆè§£å†³æ–¹æ¡ˆï¼›
3. å‚è€ƒçŸ¥è¯†åº“ä¸­çš„ç›¸å…³èµ„æ–™ï¼Œå¼€å±•é’ˆå¯¹æ€§çš„å¸‚åœºè°ƒç ”å’Œé¡¹ç›®è§„åˆ’ï¼ŒåŠ å¿«é¡¹ç›®è½åœ°æ‰§è¡Œï¼›
4. å®šæœŸå¤ç›˜é¡¹ç›®è¿›å±•ï¼Œå¯¹æ¯”é˜¶æ®µç›®æ ‡ï¼ŒåŠæ—¶è°ƒæ•´ç­–ç•¥ï¼Œç¡®ä¿é¡¹ç›®æœç€æ­£ç¡®çš„æ–¹å‘å‘å±•ã€‚` : `1. æ˜ç¡®åˆ›ä¸šé¡¹ç›®çš„æ ¸å¿ƒå®šä½ï¼Œå¼€å±•è¯¦ç»†çš„å¸‚åœºè°ƒç ”ï¼Œå½¢æˆé¡¹ç›®è§„åˆ’æ–¹æ¡ˆï¼›
2. æ­å»ºæ ¸å¿ƒåˆ›ä¸šå›¢é˜Ÿï¼Œæ˜ç¡®è‚¡æƒåˆ†é…å’ŒèŒè´£åˆ†å·¥ï¼Œå»ºç«‹å›¢é˜Ÿç®¡ç†åˆ¶åº¦ï¼›
3. ç¼–å†™å®Œå–„çš„å•†ä¸šè®¡åˆ’ä¹¦ï¼Œå¯¹æ¥ç²¾å‡†çš„èèµ„æ¸ é“å’Œèµ„æºï¼›
4. å¿«é€Ÿæ¨å‡ºæœ€å°å¯è¡Œäº§å“ï¼ˆMVPï¼‰ï¼Œé€šè¿‡å¸‚åœºåé¦ˆè¿­ä»£ä¼˜åŒ–ï¼Œå®ç°é¡¹ç›®è½åœ°ã€‚`}

## äº”ã€ä¸“ä¸šå¯„è¯­
åˆ›ä¸šæ˜¯ä¸€åœºæŒä¹…æˆ˜ï¼Œéœ€è¦åšå®šçš„ä¿¡å¿µã€æ¸…æ™°çš„æ€è·¯ã€å¼ºå¤§çš„æ‰§è¡ŒåŠ›å’Œè‰¯å¥½çš„å¿ƒæ€ï¼Œæ—¢è¦ä»°æœ›æ˜Ÿç©ºï¼Œä¹Ÿè¦è„šè¸å®åœ°ã€‚å»ºè®®åœ¨åˆ›ä¸šè¿‡ç¨‹ä¸­ä¿æŒåˆå¿ƒï¼Œèšç„¦æ ¸å¿ƒï¼Œä¸æ–­å­¦ä¹ ï¼Œå‹‡äºè¯•é”™ï¼Œç›¸ä¿¡åªè¦æ–¹å‘æ­£ç¡®ã€åšæŒåŠªåŠ›ï¼Œå°±ä¸€å®šèƒ½å®ç°åˆ›ä¸šç›®æ ‡ï¼
`;
        }
        
        // æ¸²æŸ“ç»“æœï¼ˆæ”¯æŒmarkdownç®€æ˜“è§£æï¼‰
        resultContent.innerHTML = result
          .replace(/# (.*?)\n/g, '<h1 class="text-xl font-bold mb-3">$1</h1>')
          .replace(/## (.*?)\n/g, '<h2 class="text-lg font-bold mb-2">$1</h2>')
          .replace(/### (.*?)\n/g, '<h3 class="text-base font-bold mb-1">$1</h3>')
          .replace(/- (.*?)\n/g, '<p class="mb-1"><i class="fa fa-circle text-xs mr-2"></i>$1</p>')
          .replace(/\n/g, '<br>');
    }, 1500);
  }

  // æ¸²æŸ“çŸ¥è¯†åº“åˆ—è¡¨
  function renderKnowledgeList(keyword = '') {
    const knowledgeList = JSON.parse(localStorage.getItem(STORAGE_KEYS.KNOWLEDGE));
    const filteredList = keyword 
      ? knowledgeList.filter(k => k.title.toLowerCase().includes(keyword) || k.type.toLowerCase().includes(keyword) || k.author.toLowerCase().includes(keyword))
      : knowledgeList;
    const knowledgeContainer = document.getElementById('knowledge-list');
    
    if (filteredList.length === 0) {
      knowledgeContainer.innerHTML = `<div class="col-span-full text-center text-neutral py-10">${keyword ? 'æœªæ‰¾åˆ°ç›¸å…³èµ„æ–™' : 'çŸ¥è¯†åº“æš‚æ— èµ„æ–™ï¼Œå¿«æ¥ä¸Šä¼ ç¬¬ä¸€æ¡åˆ›ä¸šèµ„æ–™å§ï¼'}</div>`;
      return;
    }
    
    knowledgeContainer.innerHTML = '';
    filteredList.forEach(knowledge => {
      const knowledgeCard = document.createElement('div');
      knowledgeCard.className = 'bg-white rounded-lg shadow-sm border border-gray-100 p-4 card-hover';
      knowledgeCard.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <h4 class="font-medium text-base truncate">${knowledge.title}</h4>
          <span class="px-2 py-0.5 bg-primary/10 text-primary rounded text-xs">${knowledge.type}</span>
        </div>
        <p class="text-sm text-neutral line-clamp-3 min-h-[40px] mb-3">${knowledge.content}</p>
        <div class="flex justify-between items-center text-xs text-neutral">
          <span>ä¸Šä¼ äººï¼š${knowledge.author}</span>
          <span>${knowledge.time}</span>
        </div>
        <button class="w-full mt-3 py-1.5 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition-colors text-sm view-knowledge-btn" data-id="${knowledge.id}">
          æŸ¥çœ‹è¯¦æƒ…
        </button>
      `;
      knowledgeContainer.appendChild(knowledgeCard);
      
      // ç»‘å®šæŸ¥çœ‹è¯¦æƒ…äº‹ä»¶
      knowledgeCard.querySelector('.view-knowledge-btn').addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        viewKnowledge(id);
      });
    });
  }

  // æŸ¥çœ‹çŸ¥è¯†åº“èµ„æ–™è¯¦æƒ…
  function viewKnowledge(id) {
    const knowledgeList = JSON.parse(localStorage.getItem(STORAGE_KEYS.KNOWLEDGE));
    const knowledge = knowledgeList.find(k => k.id === id);
    if (!knowledge) return;
    
    document.getElementById('view-title').textContent = knowledge.title;
    document.getElementById('view-type').textContent = knowledge.type;
    document.getElementById('view-author').textContent = knowledge.author;
    document.getElementById('view-time').textContent = knowledge.time;
    document.getElementById('view-content').textContent = knowledge.content;
    
    document.getElementById('view-modal').classList.remove('hidden');
  }

  // æ ¼å¼åŒ–æ—¶é—´
  function formatTime(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hour = String(date.getHours()).padStart(2, '0');
    const minute = String(date.getMinutes()).padStart(2, '0');
    const second = String(date.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
  }

  // æ¸²æŸ“æ‰€æœ‰æ•°æ®
  function renderAllData() {
    renderTopics('active');
    renderKnowledgeList();
  }

  // è§¦å‘æ™ºèƒ½ä½“åˆ†æ
  function triggerAgentAnalysis(topicId) {
    const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
    const topic = topics.find(t => t.id === topicId);
    if (!topic) return;

    const agentRecords = document.getElementById('agent-records');
    agentRecords.innerHTML = `<div class="text-center text-neutral text-sm py-4"><i class="fa fa-spinner fa-spin mr-2"></i>æ™ºèƒ½ä½“æ­£åœ¨åˆ†æè®®é¢˜å†…å®¹...</div>`;

    setTimeout(() => {
      const summary = topic.summary || generateTopicSummary(topic);
      const guide = generateTopicGuide(topic);

      const record = {
        id: Date.now().toString(),
        topicId: topic.id,
        topicTitle: topic.title,
        summary: summary,
        guide: guide,
        time: formatTime(new Date())
      };

      topic.agentRecords.push(record);
      localStorage.setItem(STORAGE_KEYS.TOPICS, JSON.stringify(topics));

      updateBusinessPlan(topicId, summary, guide);
      renderAgentRecords(topicId);
    }, 1500);
  }

  // ç”Ÿæˆè®®é¢˜æ€»ç»“
  function generateTopicSummary(topic) {
    const messages = topic.messages;
    const discussionPoints = messages.map(msg => msg.content).join('\n');
    
    return `è®®é¢˜ã€Š${topic.title}ã€‹è®¨è®ºæ€»ç»“ï¼š

æ ¸å¿ƒè§‚ç‚¹ï¼š
${messages.slice(0, 3).map(msg => `- ${msg.sender}: ${msg.content.substring(0, 50)}...`).join('\n')}

è®¨è®ºè¦ç‚¹ï¼š
1. è®®é¢˜å‘èµ·äºº${topic.founder}æå‡ºäº†${topic.title}çš„æ ¸å¿ƒé—®é¢˜
2. å…±æœ‰${messages.length}æ¡è®¨è®ºç•™è¨€ï¼Œå‚ä¸è®¨è®º${[...new Set(messages.map(m => m.sender))].length}äºº
3. è®¨è®ºä¸»è¦é›†ä¸­åœ¨${topic.content.substring(0, 30)}...ç›¸å…³å†…å®¹

å¾…è§£å†³é—®é¢˜ï¼š
${topic.summary ? topic.summary : 'éœ€è¦è¿›ä¸€æ­¥æ˜ç¡®é¡¹ç›®å®šä½ã€å¸‚åœºç­–ç•¥å’Œæ‰§è¡Œè®¡åˆ’'}`;
  }

  // ç”Ÿæˆè®®é¢˜æŒ‡å¯¼å»ºè®®
  function generateTopicGuide(topic) {
    return `é’ˆå¯¹è®®é¢˜ã€Š${topic.title}ã€‹çš„ä¸“ä¸šæŒ‡å¯¼å»ºè®®ï¼š

1. é¡¹ç›®å®šä½å»ºè®®
   - å»ºè®®è¿›ä¸€æ­¥æ˜ç¡®é¡¹ç›®çš„æ ¸å¿ƒä»·å€¼å’Œå·®å¼‚åŒ–ä¼˜åŠ¿
   - èšç„¦ç»†åˆ†å¸‚åœºï¼Œé¿å…ä¸å¤§å‹ä¼ä¸šæ­£é¢ç«äº‰
   - æ˜ç¡®ç›®æ ‡ç”¨æˆ·ç”»åƒï¼Œç²¾å‡†å®šä½éœ€æ±‚

2. å¸‚åœºç­–ç•¥å»ºè®®
   - å¼€å±•æ·±å…¥çš„å¸‚åœºè°ƒç ”ï¼ŒéªŒè¯éœ€æ±‚çœŸå®æ€§
   - åˆ†æç«äº‰å¯¹æ‰‹ï¼Œæ‰¾åˆ°å¸‚åœºç©ºç™½ç‚¹
   - åˆ¶å®šåˆ†é˜¶æ®µçš„å¸‚åœºè¿›å…¥ç­–ç•¥

3. æ‰§è¡Œè®¡åˆ’å»ºè®®
   - åˆ¶å®šè¯¦ç»†çš„é‡Œç¨‹ç¢‘å’Œæ—¶é—´èŠ‚ç‚¹
   - å»ºç«‹å…³é”®ç»©æ•ˆæŒ‡æ ‡ï¼ˆKPIï¼‰ä½“ç³»
   - å®šæœŸå¤ç›˜å’Œè°ƒæ•´ç­–ç•¥

4. å›¢é˜Ÿå»ºè®¾å»ºè®®
   - æ˜ç¡®å›¢é˜Ÿåˆ†å·¥å’ŒèŒè´£
   - å»ºç«‹æœ‰æ•ˆçš„æ²Ÿé€šæœºåˆ¶
   - æ³¨é‡å›¢é˜Ÿæ–‡åŒ–å’Œä»·å€¼è§‚å»ºè®¾`;
  }

  // æ›´æ–°åˆ›ä¸šè®¡åˆ’ä¹¦
  function updateBusinessPlan(topicId, summary, guide) {
    const businessPlan = JSON.parse(localStorage.getItem(STORAGE_KEYS.BUSINESS_PLAN));
    const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
    const topic = topics.find(t => t.id === topicId);
    
    if (!topic) return;

    const outline = businessPlan.outline;
    
    if (!outline['é¡¹ç›®æ¦‚è¿°']) {
      outline['é¡¹ç›®æ¦‚è¿°'] = `é¡¹ç›®åç§°ï¼š${topic.title}\né¡¹ç›®èƒŒæ™¯ï¼š${topic.content}\nå‘èµ·äººï¼š${topic.founder}`;
    }
    
    if (!outline['å¸‚åœºåˆ†æ']) {
      outline['å¸‚åœºåˆ†æ'] = `åŸºäºè®®é¢˜è®¨è®ºï¼Œé¡¹ç›®å¸‚åœºåˆ†æå¦‚ä¸‹ï¼š\n${summary}`;
    }
    
    if (!outline['äº§å“/æœåŠ¡ä»‹ç»']) {
      outline['äº§å“/æœåŠ¡ä»‹ç»'] = `äº§å“/æœåŠ¡æ ¸å¿ƒåŠŸèƒ½å¾…è¿›ä¸€æ­¥æ˜ç¡®ï¼Œå»ºè®®ç»“åˆè®¨è®ºå†…å®¹å®Œå–„ã€‚`;
    }
    
    if (!outline['å•†ä¸šæ¨¡å¼']) {
      outline['å•†ä¸šæ¨¡å¼'] = `å•†ä¸šæ¨¡å¼å¾…è¿›ä¸€æ­¥è®¾è®¡ï¼Œå»ºè®®å‚è€ƒä¸“ä¸šæŒ‡å¯¼å»ºè®®ã€‚`;
    }
    
    if (!outline['å›¢é˜Ÿä»‹ç»']) {
      outline['å›¢é˜Ÿä»‹ç»'] = `å‘èµ·äººï¼š${topic.founder}\nå›¢é˜Ÿæˆå‘˜å¾…è¿›ä¸€æ­¥è¡¥å……ã€‚`;
    }
    
    if (!outline['å‘å±•è§„åˆ’']) {
      outline['å‘å±•è§„åˆ’'] = `çŸ­æœŸè§„åˆ’ï¼šå®Œæˆé¡¹ç›®åˆæ­¥è®¾è®¡\nä¸­æœŸè§„åˆ’ï¼šå¸‚åœºéªŒè¯å’Œè¿­ä»£\né•¿æœŸè§„åˆ’ï¼šè§„æ¨¡åŒ–å‘å±•`;
    }
    
    if (!outline['è´¢åŠ¡é¢„æµ‹']) {
      outline['è´¢åŠ¡é¢„æµ‹'] = `å¯åŠ¨èµ„é‡‘å¾…æ˜ç¡®\næ”¶å…¥é¢„æµ‹å¾…å®Œå–„\næˆæœ¬åˆ†æå¾…è¡¥å……`;
    }
    
    if (!outline['é£é™©åˆ†æ']) {
      outline['é£é™©åˆ†æ'] = `å¸‚åœºé£é™©ã€æŠ€æœ¯é£é™©ã€èµ„é‡‘é£é™©å¾…è¿›ä¸€æ­¥åˆ†æã€‚`;
    }
    
    if (!outline['é™„ä»¶èµ„æ–™']) {
      outline['é™„ä»¶èµ„æ–™'] = `è®®é¢˜è®¨è®ºè®°å½•ã€ä¸“ä¸šæŒ‡å¯¼å»ºè®®å·²è‡ªåŠ¨å…³è”ã€‚`;
    }

    businessPlan.outline = outline;
    localStorage.setItem(STORAGE_KEYS.BUSINESS_PLAN, JSON.stringify(businessPlan));
    
    const currentTopicId = sessionStorage.getItem('current_topic_id');
    if (currentTopicId === topicId) {
      renderBusinessPlan();
    }
  }

  // æ¸²æŸ“æ™ºèƒ½ä½“è®°å½•
  function renderAgentRecords(topicId) {
    const topics = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOPICS));
    const topic = topics.find(t => t.id === topicId);
    if (!topic) return;

    const agentRecords = document.getElementById('agent-records');
    
    if (topic.agentRecords.length === 0) {
      agentRecords.innerHTML = `<div class="text-center text-neutral text-sm py-4">æ™ºèƒ½ä½“å°†è‡ªåŠ¨è®°å½•æ¯æ¬¡è®®é¢˜è®¨è®ºå¹¶ç”Ÿæˆä¸“ä¸šæŒ‡å¯¼å»ºè®®</div>`;
      return;
    }

    agentRecords.innerHTML = '';
    topic.agentRecords.forEach(record => {
      const recordItem = document.createElement('div');
      recordItem.className = 'bg-gray-50 rounded-lg p-3 border border-gray-200';
      recordItem.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <span class="font-medium text-sm text-primary">${record.topicTitle}</span>
          <span class="text-xs text-neutral">${record.time}</span>
        </div>
        <div class="text-xs text-neutral mb-2">
          <div class="font-medium mb-1">è®¨è®ºæ€»ç»“ï¼š</div>
          <div class="whitespace-pre-line">${record.summary.substring(0, 100)}...</div>
        </div>
        <div class="text-xs text-neutral">
          <div class="font-medium mb-1">ä¸“ä¸šæŒ‡å¯¼ï¼š</div>
          <div class="whitespace-pre-line">${record.guide.substring(0, 100)}...</div>
        </div>
      `;
      agentRecords.appendChild(recordItem);
    });
  }

  // æ¸²æŸ“åˆ›ä¸šè®¡åˆ’ä¹¦
  function renderBusinessPlan() {
    const businessPlan = JSON.parse(localStorage.getItem(STORAGE_KEYS.BUSINESS_PLAN));
    const outline = businessPlan.outline;
    const completedSections = businessPlan.completedSections;
    
    const planOutline = document.getElementById('plan-outline');
    const planProgress = document.getElementById('plan-progress');
    
    const totalSections = Object.keys(outline).length;
    const completedCount = completedSections.length;
    const progress = Math.round((completedCount / totalSections) * 100);
    
    planProgress.textContent = `å®Œæˆåº¦ï¼š${progress}%`;
    
    planOutline.innerHTML = '';
    Object.entries(outline).forEach(([section, content]) => {
      const sectionItem = document.createElement('div');
      const isCompleted = completedSections.includes(section);
      sectionItem.className = `p-3 rounded-lg border ${isCompleted ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'}`;
      sectionItem.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <span class="font-medium text-sm ${isCompleted ? 'text-green-700' : 'text-dark'}">${section}</span>
          <span class="text-xs ${isCompleted ? 'text-green-600' : 'text-neutral'}">${isCompleted ? 'å·²å®Œæˆ' : 'å¾…å®Œå–„'}</span>
        </div>
        <div class="text-xs text-neutral line-clamp-2">${content || 'æš‚æ— å†…å®¹'}</div>
      `;
      planOutline.appendChild(sectionItem);
    });
  }

  // æ¸²æŸ“å®Œæ•´åˆ›ä¸šè®¡åˆ’ä¹¦
  function renderFullBusinessPlan() {
    const businessPlan = JSON.parse(localStorage.getItem(STORAGE_KEYS.BUSINESS_PLAN));
    const outline = businessPlan.outline;
    const completedSections = businessPlan.completedSections;
    
    const fullPlanContent = document.getElementById('full-plan-content');
    const fullPlanProgress = document.getElementById('full-plan-progress');
    const fullPlanProgressBar = document.getElementById('full-plan-progress-bar');
    
    const totalSections = Object.keys(outline).length;
    const completedCount = completedSections.length;
    const progress = Math.round((completedCount / totalSections) * 100);
    
    fullPlanProgress.textContent = `${progress}%`;
    fullPlanProgressBar.style.width = `${progress}%`;
    
    fullPlanContent.innerHTML = '';
    Object.entries(outline).forEach(([section, content]) => {
      const sectionItem = document.createElement('div');
      const isCompleted = completedSections.includes(section);
      sectionItem.className = `p-4 rounded-lg border ${isCompleted ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'}`;
      sectionItem.innerHTML = `
        <div class="flex justify-between items-center mb-3">
          <h4 class="font-medium text-base ${isCompleted ? 'text-green-700' : 'text-dark'}">${section}</h4>
          <div class="flex items-center gap-2">
            <span class="text-xs px-2 py-1 rounded-full ${isCompleted ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${isCompleted ? 'å·²å®Œæˆ' : 'å¾…å®Œå–„'}</span>
            <button class="edit-section-btn text-xs text-primary hover:text-primary/80 px-2 py-1 border border-primary rounded hover:bg-primary/10 transition-colors" data-section="${section}">
              <i class="fa fa-edit mr-1"></i>ç¼–è¾‘
            </button>
          </div>
        </div>
        <div class="text-sm text-neutral whitespace-pre-line leading-relaxed">${content || 'æš‚æ— å†…å®¹'}</div>
      `;
      fullPlanContent.appendChild(sectionItem);
    });
    
    // ç»‘å®šç« èŠ‚ç¼–è¾‘æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.edit-section-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const section = this.getAttribute('data-section');
        openEditSectionModal(section);
      });
    });
  }

  // æ‰“å¼€å•ä¸ªç« èŠ‚ç¼–è¾‘å¼¹çª—
  function openEditSectionModal(section) {
    const businessPlan = JSON.parse(localStorage.getItem(STORAGE_KEYS.BUSINESS_PLAN));
    const outline = businessPlan.outline;
    const content = outline[section] || '';
    
    const editPlanContent = document.getElementById('edit-plan-content');
    editPlanContent.innerHTML = '';
    
    const sectionEdit = document.createElement('div');
    sectionEdit.className = 'space-y-2';
    sectionEdit.innerHTML = `
      <label class="block text-sm font-medium text-dark">${section}</label>
      <textarea class="plan-section-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary min-h-[200px]" data-section="${section}">${content}</textarea>
    `;
    editPlanContent.appendChild(sectionEdit);
    
    document.getElementById('edit-plan-modal').classList.remove('hidden');
  }

  // æ‰“å¼€ç¼–è¾‘è®¡åˆ’ä¹¦å¼¹çª—
  function openEditPlanModal() {
    const businessPlan = JSON.parse(localStorage.getItem(STORAGE_KEYS.BUSINESS_PLAN));
    const outline = businessPlan.outline;
    
    const editPlanContent = document.getElementById('edit-plan-content');
    editPlanContent.innerHTML = '';
    
    Object.entries(outline).forEach(([section, content]) => {
      const sectionEdit = document.createElement('div');
      sectionEdit.className = 'space-y-2';
      sectionEdit.innerHTML = `
        <label class="block text-sm font-medium text-dark">${section}</label>
        <textarea class="plan-section-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary min-h-[100px]" data-section="${section}">${content || ''}</textarea>
      `;
      editPlanContent.appendChild(sectionEdit);
    });
    
    document.getElementById('edit-plan-modal').classList.remove('hidden');
  }

  // ä¿å­˜åˆ›ä¸šè®¡åˆ’ä¹¦
  function saveBusinessPlan() {
    const businessPlan = JSON.parse(localStorage.getItem(STORAGE_KEYS.BUSINESS_PLAN));
    const outline = businessPlan.outline;
    const completedSections = [];
    
    document.querySelectorAll('.plan-section-input').forEach(textarea => {
      const section = textarea.getAttribute('data-section');
      const content = textarea.value.trim();
      outline[section] = content;
      if (content) {
        completedSections.push(section);
      }
    });
    
    businessPlan.outline = outline;
    businessPlan.completedSections = completedSections;
    
    localStorage.setItem(STORAGE_KEYS.BUSINESS_PLAN, JSON.stringify(businessPlan));
    
    document.getElementById('edit-plan-modal').classList.add('hidden');
    alert('è®¡åˆ’ä¹¦ä¿å­˜æˆåŠŸï¼');
    
    renderBusinessPlan();
  }
</script>
</body>
</html>
